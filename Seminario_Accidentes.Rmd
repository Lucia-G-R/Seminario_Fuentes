---
title: "Desarrollo de distintas enfermedades según el oficio"
subtitle: "Fuentes de datos biomédicas y web semántica, Grado en Ingeniería de la Salud"
author: "Lorena Nerín Grau y Lucía González Redondo"
class: "3º Ingeniería de la Salud"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
  pdf_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introducción**
El desarrollo de enfermedades laborales pueden ocasionar bajas laborales. Estás enfermedades se producen en el ámbito laboral según el trabajo realizado, pero queremos estudiar como el desarrollo de estas enfermedades se puede agravar por poseer una enfermedad mental, incluso si la gravedad de la enfermedad laboral es distinta entre géneros o debido a la profesión realizada.

# **Objetivo general**
Evaluación del desarrollo de enfermedades laborales, respecto a la profesión y el estado de salud mental.

# **Objetivo específico**
- ¿Existe relación la profesión de movimiento de tierra respecto al desarrollo de enfermedades psicológicas?
- ¿Existe relación entre el desarrollo de enfermedades laborales respecto al sexo?
- ¿Exsite relación entre la gravedad de una enfermedad psicológica respecto al desarrollo de una enfermedad laboral?

# **Metodología**
## **Materiales**
Agregamos los URL del lugar de obtención de los datos:
- [Enfermedades laborales](https://datos.gob.es/es/catalogo/ea0010587-personas-de-16-a-74-ocupadas-anos-o-que-trabajaron-anteriormente-que-hayan-tenido-alguna-enfermedadlaboral-por-tipo-de-enfermedad-y-sexo-epa-identificador-api-t22-e308-meto_05-modulo-base_2011-2020-l0-02003-px1)
- [Estado de salud mental](https://datos.gob.es/es/catalogo/a05003423-poblacion-de-16-y-mas-anos-segun-autovaloracion-del-estado-de-salud-en-relacion-a-situaciones-de-ansiedad-o-depresion-sexos-o-grupos-de-edad-por-anos-canarias-2004-2009)
- [Tipos de trabajos](https://datos.gob.es/es/catalogo/a05003423-accidentes-de-trabajo-en-jornada-segun-tipos-de-trabajo-gravedad-trabajo-habitual-o-no-y-sexos-canarias-y-anos)
- [Grado de lesión de la enfermedad laboral](https://datos.gob.es/es/catalogo/a02002834-accidentes-en-jornada-de-trabajo-n-de-accidentes-segun-grado-de-lesion-y-sexo)

Agregamos el URL del repositorio:
- [Repositorio](https://github.com/Lucia-G-R/Seminario_Fuentes.git)

## **Carga de datos**
### **Descargar datos**
Podemos descargar los datos de Canarias en formato .csv de la página web de datos del gobierno de España, desde R mediante este código:
```{r, eval=FALSE, error = TRUE}
#install.packages("readxl")
library(readxl)

# URL del archivo Excel en GitHub
url <- "https://github.com/Lucia-G-R/Seminario_Fuentes/blob/main/INPUT/DATA/Accidentes_laborales_Canarias.csv.csv"

# Creamos un archivo temporal para almacenar el Excel
temp <- tempfile(fileext = ".csv")

# Descargamos el archivo desde GitHub
download.file(https://datos.gob.es/es/catalogo/a05003423-accidentes-de-trabajo-en-jornada-segun-tipos-de-trabajo-gravedad-trabajo-habitual-o-no-y-sexos-canarias-y-anos, destfile = temp, mode = "wb")
```

### **Carga de paquetes**
Paquetes necesarios para JSON
```{r}
# Paquetes necesarios para JSON 
#install.packages("tidyjson")
```
Paquetes necesarios para xls
```{r}
# Paquetes necesarios para xls
#install.packages("readxl")
```
Paquetes necesarios para csv
```{r}
# Paquetes necesarios para csv
#install.packages("readr")
```
Paquetes necesarios para xlsx
```{r}
# Paquetes necesarios para xlsx
#install.packages("readxl")
```
Paquete necesario para la manipulación de dataframes
```{r}
# Paquete necesario para la manipulación de dataframes
#install.packages("dplyr") 
```
Paquete necesario para transformar las filas y columnas
```{r}
# Paquete necesario para transformar las filas y columnas
#install.packages("tidyverse")
```
Paquete para mostrar las tablas formatedas
```{r}
#Paquete para mostrar tablas formatedas
#install.packages("DT")
```

### **Carga de datos JSON**
Queremos extraer los datos sobre las enfermedades laborales que suceden en España. 
Como es un archivo con extensión .JSON con listas anidadas sin etiquetar, no podemos utilizar directamente un tibbe para ello, utilizaremos tidyjson.
```{r, warning=FALSE} 
library(rjson)
library(tidyverse)
library(tidyjson)
library(dplyr)
library(DT)

# Cargamos el archivo JSON, pero está en formato de lista.
espana_json <- fromJSON(file = "INPUT/DATA/Enfermedades_laborales_España.json")

# Observamos la estructura, nos damos cuenta que posee listas anidadas
#str(espana_json)

# Convertimos la lista de la varable MetaData en un dataframe
MetaData_df<-
  espana_json%>%
  enter_object("MetaData")%>% # Extreamos la infromación dentro de "MetaData"
  gather_array() %>% # Convierte los elementos de un array en filas
  spread_all()%>% # Esta función distribuye cualquier objeto JSON que sea escalar en nuevas columnas
  select(T3_Variable, Nombre, Codigo) # Seleccionamos las tres variables que posee 

# Convertimos la lista de la variable Data en un dataframe
Data_df<-
  espana_json%>%
  enter_object("Data")%>% # Extreamos la infromación dentro de "Data"
  gather_array() %>% 
  spread_all()%>%
  select(Valor) # Seleccionamos la variable que posee 

# Unimos MetaData_df y Data_df usando "..JSON". Extraemos la columna "..JSON" como identificador 
# Expandimos la columna "..JSON" con prefijo para evitar conflictos de nombres
MetaData_df <- 
  MetaData_df %>%
  unnest_wider(..JSON, names_sep = "_json")

Data_df <- 
  Data_df %>%
  unnest_wider(..JSON, names_sep = "_json")

# Creamos un identificador único para cada fila
MetaData_df <- 
  MetaData_df %>%
  mutate(id = row_number())

Data_df <- 
  Data_df %>%
  mutate(id = row_number())

# Hacemos la unión de los df por la columna id que hemos creado con la variable lista "..JSON"
espana_df <- 
  MetaData_df %>%
  left_join(Data_df, by = "id") %>% # Unimos con Data_df usando 'id'
  mutate(Nombre = espana_json$Nombre) # Agregamos la columna "Nombre" del espana_json

#attributes(MetaData_df)  
#attributes(Data_df)
#print(MetaData_df)
#print(Data_df)
#print(espana_json)
#print(espana_df)


datatable(espana_df)
```

### **Carga de datos XLS**
Queremos extraer los datos sobre los accidentes laborales que suceden en Canarias. 
Como es un archivo con extensión .xls, utilizamos read_excel.
```{r, warning=FALSE}
# Cargamos los archivos con extensión .xls
library(readxl)
library(DT)

canarias_df <- read_excel("INPUT/DATA/Accidentes_laborales_Canarias.xls")
#class(canarias_df)

#print(canarias_df)
datatable(canarias_df)
```

### **Carga de datos CSV**
Queremos extraer los datos sobre la salud mental en los habitantes de Canarias. 
Como es un archivo con extensión .csv, utilizamos read_delim e indicamos que el delimitador es ;
```{r, warning=FALSE}
# Cargamos los archivos con extensión .csv
library(readr)
library((DT))

Salud_df <- read_delim ("INPUT/DATA/Estados_de_salud_Canarias.csv.csv", delim = ";")
#class(Salud_df)

#print(Salud_df)
datatable(Salud_df)
```

### **Carga de datos XLSX**
Queremos extraer los datos sobre la gravedad de las enfermedades laborales producidas en Aragón. 
Como es un archivo con extensión .xlsx, utilizamos read_excel.
```{r, warning=FALSE}
# Cargamos los archivos con extensión .xlsx
library(readxl)
library(DT)

Aragon_df <- read_excel ("INPUT/DATA/070901-02_Por grado y sexo. Aragon.xlsx")
#class(Aragon_df)

print(Aragon_df)
datatable(Aragon_df)
```

## **Cambiar nombre de las columnas**
Vamos a cambiar los nombres de las distintas columnas de los datos extraídos.
Cambiamos los nombres de las columnas del conjunto de datos sobre los accidentes laborales que suceden en Canarias.
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(canarias_df)
canarias <- rename(.data = canarias_df, Año = `TIME_PERIOD#es`, Año2 = `TIME_PERIOD_CODE`, Sexo = `SEXO#es`, SexoCod = `SEXO_CODE`, Gravedad = `ACCIDENTE_GRAVEDAD#es`, GravedadCod = `ACCIDENTE_GRAVEDAD_CODE`, TipoTrab = `TIPO_TRABAJO#es`, TipoTrabCod = `TIPO_TRABAJO_CODE`, TrabHabitual = `TRABAJO_HABITUAL#es`, TrabHabCod = `TRABAJO_HABITUAL_CODE`, Obs = `OBS_VALUE`, ConfeciObs = `CONFIDENCIALIDAD_OBSERVACION#es`, Notasobs = `NOTAS_OBSERVACION#es`, Estadosobs = `ESTADO_OBSERVACION#es`)

#print(canarias)
datatable(canarias)
```
Cambiamos los nombres de las columnas del conjunto de datos sobre la gravedad de las enfermedades laborales producidas en Aragón. 
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(Aragon_df)
Aragon <- rename(.data = Aragon_df, NumAcci = `Nº Accidentes`, Gravedad = `Grupo Grado Código...4`, GravedadCod = `Grupo Grado Código...5`)

#print(Aragon)
datatable(Aragon)
```

Cambiamos los nombres de las columnas del conjunto de datos sobre las enfermedades laborales que suceden en España. 
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(espana_df)
Espana <- rename(.data = espana_df, TipoEnf = `T3_Variable`, Indicador = `Codigo`, Variable = `..JSON_jsonT3_Variable`, Nombre = `..JSON_jsonNombre`, Codigo = `..JSON_jsonCodigo`, jsonValor = `..JSON_jsonValor`)

#print(Espana)
datatable(Espana)
```
Cambiamos los nombres de las columnas del conjunto de datos sobre la salud mental en los habitantes de Canarias.
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(Salud_df)
Salud <- rename(.data = Salud_df, Sexo = `sexos_grupos_edad`, EstadoAnsiedad = `autovaloracion_estado_salud_relacion_situaciones_ansiedad`, Años = `anios`, Obs = `poblacion_16_mas_anios`)

#print(Salud)
datatable(Salud)
```

## **Eliminar los valores nulos**
Eliminamos los valores nulos del conjunto de datos sobre los accidentes laborales que suceden en Canarias. Con select observamos las columnas que poseen valores nulos..
```{r, warning=FALSE}
library(dplyr)

canarias %>%
select(where(~ all(is.na(.))))
```
Para poder eliminar las columnas que poseen datos con argumentos nulos utilizamos la función  filter que nos devolverá solo las columnas con valores de interés.
```{r, warning=FALSE}
canarias <- Filter(function(x) !all(is.na(x)), canarias)
#print(canarias)
```

## **Eliminar columnas**
Eliminamos las columnas que no nos va a interesar estudiar para ello, seleccionamos las columnas que nos interesan. 
En el único conjunto de datos que no vamos a eliminar columnas es en los datos sobre la salud mental en los habitantes de Canarias.
```{r, warning=FALSE} 
library(dplyr)

canarias <- 
  canarias%>% 
  select(Año, Sexo, Gravedad, TipoTrab, Obs)


Aragon <- 
  Aragon%>%
  select(Año, Sexo, NumAcci, Gravedad)


Espana <- 
  Espana%>%
  select(TipoEnf, Nombre, id, Valor)
```

## **Eliminar filas**
Eliminamos las filas que no nos va a interesar estudiar.
```{r, error = TRUE, warning=FALSE}
#ELIMINAR FILAS

Salud <- subset(Salud, !Sexo %in% c("De 16 a 64 a\xf1os", "De 65 y m\xe1s a\xf1os"))

#canarias <- subset(canarias, !TipoTrabCod %in% c("4|9|_T|3|6|0|5|1"))

Espana <- subset (Espana, !TipoEnf %in% c ("Cardiopartía|Dolor de cabeza|infecciosa|No sabe|problema de salud|Problemaauditivo|dermatológico|gástrico|respiratorio|Total"))
```

## **Realizar un dataframe conjunto**
Realizamos un dataframe uniendo los datos sobre la gravedad de las enfermedades laborales en Aragón y la salud mental de los ciudadanos en Canarias.
```{r, warning=FALSE}
# Unimos por una columna común "Sexo"
df_Salu_Arag <- merge(Aragon, Salud, by = "Sexo")

print(df_Salu_Arag)
```
Realizamos un dataframe uniendo los datos sobre los accidentes laborales que suceden en Canarias y los datos sobre las enfermedades laborales que suceden en España. Como tenemos dos nombres de columnas diferentes aunque recoge el mismo tipo de valores.
```{r, error = TRUE, warning=FALSE}
# Unimos por una columna diferente en canarias estrá la columna Obs y en Espana estará la columna Valor
df_cana_Esp <- merge(canarias, Espana, by = c(Obs = Valor))

print(df_cana_Esp)
```

## **Pivotar**
Vamos a transponer la estructura de nuestra tabla ordenada Espana desde largo a ancho.
```{r, error = TRUE, warning=FALSE}
pivot_wider(data = Espana, names_from = "TipoEnf")
```

## **Gráfico**
```{r pressure, echo=FALSE, warning=FALSE}
plot(pressure)
```

# **Resultados**

# **Conclusiones**

# **Referencias**
https://osha.europa.eu/es/themes/work-related-diseases
https://www.who.int/es/news-room/fact-sheets/detail/mental-disorders


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.