---
title: "Seminario_Accidentes"
author: "Lorena Nerín y Lucía González"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introdcucción**
Las enfermedades laborales

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```




Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}
# Instalar la librería readxl si no la tienes
#install.packages("readxl")
library(readxl)
```


```{r}
# URL cruda del archivo Excel en GitHub
url <- "https://github.com/Lucia-G-R/Seminario_Fuentes/blob/main/INPUT/DATA/Accidentes_laborales_Canarias.csv.csv"
```


```{r}
# Crear un archivo temporal para almacenar el Excel
temp <- tempfile(fileext = ".xlsx")
```


```{r, eval=FALSE}
# Descargar el archivo desde GitHub
download.file(https://datos.gob.es/es/catalogo/a02002834-accidentes-en-jornada-de-trabajo-n-de-accidentes-segun-grado-de-lesion-y-sexo, destfile = "INPUT/DATA/Accidentes_laborales_Canarias.csv.csv" , mode = "wb")
```

```{r}
#CARGA JSON CANARIAS
install.packages("rjson")
library(rjson)
canarias <- fromJSON(file = "INPUT/DATA/Accidentes_laborales_Canarias.json")

print(canarias)
```

```{r}
#CARGA XLS
install.packages("readxl")
library(readxl)
España <- read_excel("INPUT/DATA/Enfermedades_laborales_España.xls")
print(España)
```


```{r}
#CARGA CSV
install.packages("readr")
library(readr)
Salud <- read_delim ("INPUT/DATA/Estados_de_salud_Canarias.csv.csv", delim = ",")
print(Salud)
```

```{r}
#CARGA XLSX
install.packages("readxl")
library(readxl)
Aragon <- read_excel ("INPUT/DATA/070901-02_Por grado y sexo. Aragon.xlsx")
print(Aragon)
```

```{r}
#ESTA MAL!!!!

# Instalar y cargar las librerías necesarias
install.packages("tidyverse")    # Incluye dplyr, tidyr, etc.
install.packages("tidyjson")     # Para manejar datos JSON complejos
install.packages("rjson")        # Para leer archivos JSON

# Cargar las librerías
library(tidyverse)
library(tidyjson)
library(rjson)

# 1. Leer el archivo JSON
canarias <- fromJSON(file = "INPUT/DATA/Accidentes_laborales_Canarias.json")
print (canarias)

# 2. Ver la estructura inicial del JSON
str(canarias[["name"]][["text"]][[1]][["value"]])# Esto nos permite ver cómo está estructurado el JSON
str (canarias[["metadata"]][["rightsHolder"]][["name"]])
spread_all(canarias[["name"]][["text"]][[1]][["value"]])
spread_all(canarias[["metadata"]][["rightsHolder"]][["name"]])

# 3. Convertir el JSON a formato tabular usando `spread_all()`
canarias_df <- 
  canarias %>%
  spread_all()   # Convierte la lista JSON a un dataframe

# 4. Ver el dataframe resultante
print(head(canarias_df))  # Muestra las primeras filas del dataframe

# Si hay arrays u objetos anidados dentro del JSON:
# 5. Entrar en un objeto anidado y aplanar arrays si existen
canarias_anidado <- canarias %>%
  spread_all() %>%         # Aplanar la estructura principal
  enter_object("nombre_del_objeto") %>%  # Reemplaza con el nombre del objeto anidado si es necesario
  gather_array() %>%       # Aplanar arrays en filas si existen
  spread_all()             # Convertir el contenido anidado en un formato tabular

# 6. Ver el dataframe con los objetos anidados expandidos (si existen)
print(head(canarias_anidado))

# 7. Guardar el dataframe en una variable final
final_canarias_df <- canarias_anidado

# 8. Verificar el tamaño de los objetos (opcional)
lobstr::obj_size(canarias_df)
lobstr::obj_size(final_canarias_df)

# 9. Inspeccionar los tipos de datos y el contenido
final_canarias_df %>% glimpse()  # Resumen de la estructura del dataframe

```



```{r}
#CAMBIAR NOMBRE COLUMNAS
install.packages("tidyverse")
library(tidyverse)

spread_all (canarias)
colnames(canarias) <- c("Año", "Año2", "Sexo", "SexoCod", "Gravedad", "GravedadCod", "TipoTrab", "TipoTrabCod", "TrabHab", "TrabHabCod", "Obs")
#accidentes canarias

colnames(Aragon) <- c("Año", "Sexo", "NumAcci", "Gravedad", "GravedadCod", "CCAA")
#aragon

colnames(España) <- c("TipoEnf", "Indicador", "Sexo", "Obs")
#españa

colnames(Salud) <- c("Sexo", "Indicador","EstadoAnsiedad","Año","Obs")
#estado salud canarias

```

```{r}
#ELIMINAR FILAS
# Eliminar filas usando subset()
Salud <- subset(Salud, !(Sexo %in% c("De 16 a 64 años", "De 65 y más años")))

canarias <- subset(canarias, !(TipoTrabCod %in% c("4", "9", "_T", "3", "6", "0", "5", "1")))

España <- subset(España, !(TipoEnf %in% c("Cardiopartía", "Dolor de cabeza", "infecciosa", "No sabe", "problema de salud", "Problema auditivo", "dermatológico", "gástrico", "respiratorio", "Total")))

# Eliminar filas usando grepl() para mi_data4
Salud <- Salud[!grepl("De 16 a 64 años|De 65 y más años", Sexo), ]

# Eliminar filas usando grepl() para mi_data
mi_data <- mi_data[!grepl("4|9|_T|3|6|0|5|1", TipoTrabCod), ]

# Eliminar filas usando grepl() para mi_data3
España <- España[!grepl("Cardiopartía|Dolor de cabeza|infecciosa|No sabe|problema de salud|Problema auditivo|dermatológico|gástrico|respiratorio|Total", TipoEnf), ]

```


```{r}
ELIMINAR COLUMNAS
# Supongamos que quieres mantener las columnas "Col1" y "Col2"
mi_data <- subset(mi_data, select = c(Año, Sexo, Gravedad, TipoTrab, Obs))

mi_data2 <- subset(mi_data2, select = c(Año, Sexo, NumAcci, Gravedad))

mi_data3 <- subset(mi_data3, select = c(TipoEnf, Indicador, Sexo, Obs))

mi_data4 <- subset(mi_data4, select = c(Sexo, Indicador, EstadoAnsiedad, Obs))



# Mostrar las primeras filas después de eliminar
head(mi_data)

# Guardar el data frame en un nuevo archivo CSV
write.csv(mi_data, "ruta/del/archivo/datos_filtrados.csv", row.names = FALSE)

```

```{r}
HACER UN DATAFRAME JUNTO
# Unir por una columna común (ej. "ID")
combined_data <- merge(mi_data, mi_data2, by = "Año")

# Verificar el resultado
head(combined_data)

# Unir por columnas claves con diferentes nombres
combined_data <- merge(data1, data2, by.x = "ID_data1", by.y = "ID_data2")
```




# Descargar el archivo desde GitHub
download.file(url, destfile = temp, mode = "wb"

# Leer el archivo Excel desde el archivo temporal
mi_data <- read_excel(temp, sheet = 1)

# Eliminar el archivo temporal después de la lectura
unlink(temp)

# Verificar los primeros datos cargados
head(mi_data)