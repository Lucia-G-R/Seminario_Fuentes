---
title: "Desarrollo de distintas enfermedades según el oficio" 
subtitle: "Fuentes de datos biomédicas y web semántica, Grado en Ingeniería de la Salud"
author: "Lorena Nerín Grau y Lucía González Redondo"
class: "3º Ingeniería de la Salud"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
  pdf_document: 
    toc: true
---
<img src='images/imagen.png' align="right" height="80" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introducción**
El desarrollo de enfermedades laborales pueden ocasionar bajas laborales. Estas enfermedades se producen en el ámbito laboral según el trabajo realizado, queremos estudiar como el desarrollo de estas enfermedades se puede agravar por poseer una enfermedad mental, incluso si la gravedad de la enfermedad laboral es distinta entre géneros o debido a la profesión realizada.

# **Objetivo general**
Evaluación del desarrollo de enfermedades laborales, respecto a la profesión y el estado de salud mental.

# **Objetivo específico**
- ¿Existe relación la profesión de movimiento de tierra respecto al desarrollo de enfermedades psicológicas?
- ¿Existe relación entre el desarrollo de enfermedades laborales respecto al sexo?
- ¿Exsite relación entre la gravedad de una enfermedad psicológica respecto al desarrollo de una enfermedad laboral?


# **Relacion con otros articulos y estudios**
Uno de ellos tambien estudia la incidencia de enfermedades segun la economia y el sexo de los encuestados.
Segun el sexo hay diferencias significativas donde los hombres tienen mayor numero de enfermedades, ya que son estos los que ocupan los trabajos fisicos exigentes. En cuanto al tipo de trabajo el sector de la mineria, construcción y agricultura resultan los que mas enfermedades se tienen.

Otro articulo que nos ha resultado interesante es el siguiente: en Reino Unido se estudio que el personal de construccion tiene mas probabilidad de suicidarse que el promedio nacional. Según los redactores comentan que se debe a que los trabajadores no quieren buscar ayuda terapeutica, y los contratos de largas jornadas y lejos de la familia tampoco ayudan. Por ello determinan que concienciar sobre este problema y quitar el estigma es importante.

# **Metodología**
## **Materiales**
Agregamos los URL del lugar de obtención de los datos:

- [Enfermedades laborales](https://datos.gob.es/es/catalogo/ea0010587-personas-de-16-a-74-ocupadas-anos-o-que-trabajaron-anteriormente-que-hayan-tenido-alguna-enfermedadlaboral-por-tipo-de-enfermedad-y-sexo-epa-identificador-api-t22-e308-meto_05-modulo-base_2011-2020-l0-02003-px1)

- [Estado de salud mental](https://datos.gob.es/es/catalogo/a05003423-poblacion-de-16-y-mas-anos-segun-autovaloracion-del-estado-de-salud-en-relacion-a-situaciones-de-ansiedad-o-depresion-sexos-o-grupos-de-edad-por-anos-canarias-2004-2009)

- [Tipos de trabajos](https://datos.gob.es/es/catalogo/a05003423-accidentes-de-trabajo-en-jornada-segun-tipos-de-trabajo-gravedad-trabajo-habitual-o-no-y-sexos-canarias-y-anos)

- [Grado de lesión de la enfermedad laboral](https://datos.gob.es/es/catalogo/a02002834-accidentes-en-jornada-de-trabajo-n-de-accidentes-segun-grado-de-lesion-y-sexo)

Agregamos el URL del repositorio:
- [Repositorio](https://github.com/Lucia-G-R/Seminario_Fuentes.git)

### **Carga de paquetes**
Paquetes necesarios para JSON
```{r, warning=FALSE}
# Paquetes necesarios para JSON 
#install.packages("tidyjson")
```
Paquetes necesarios para xls
```{r, warning=FALSE}
# Paquetes necesarios para xls
#install.packages("readxl")
```
Paquetes necesarios para csv
```{r, warning=FALSE}
# Paquetes necesarios para csv
#install.packages("readr")
```
Paquetes necesarios para xlsx
```{r, warning=FALSE}
# Paquetes necesarios para xlsx
#install.packages("readxl")
```
Paquete necesario para la manipulación de dataframes
```{r, warning=FALSE}
# Paquete necesario para la manipulación de dataframes
#install.packages("dplyr") 
```
Paquete necesario para transformar las filas y columnas
```{r, warning=FALSE}
# Paquete necesario para transformar las filas y columnas
#install.packages("tidyverse")
```
Paquete para mostrar las tablas formatedas
```{r, warning=FALSE}
#Paquete para mostrar tablas formatedas
#install.packages("DT")
```
Paquete necesario para la implementación de gráficos
```{r}
#install.packages("ggplot2")
```

## **Carga de datos**
### **Descargar datos**
Podemos descargar los datos de Canarias en formato .csv de la página web de datos del gobierno de España, desde R mediante este código:
```{r, eval=FALSE, warning=FALSE}
#install.packages("readxl")
library(readxl)

# URL del archivo Excel en GitHub
url <- "https://github.com/Lucia-G-R/Seminario_Fuentes/blob/main/INPUT/DATA/Enfermedades_laborales_Espa%C3%B1a.csv.csv"

# Creamos un archivo temporal para almacenar el Excel
temp <- tempfile(fileext = ".csv")

# Descargamos el archivo desde GitHub
download.file("https://datos.gob.es/es/catalogo/a05003423-poblacion-de-16-y-mas-anos-segun-autovaloracion-del-estado-de-salud-en-relacion-a-situaciones-de-ansiedad-o-depresion-sexos-o-grupos-de-edad-por-anos-canarias-2004-2009", destfile = temp, mode = "wb")
```

### **Carga de datos JSON**
Queremos extraer los datos sobre las enfermedades laborales que suceden en España. 
Como es un archivo con extensión .JSON con listas anidadas sin etiquetar, no podemos utilizar directamente un tibbe para ello, utilizaremos tidyjson.
```{r, warning=FALSE} 
library(rjson)
library(tidyverse)
library(tidyjson)
library(dplyr)
library(DT)

# Cargamos el archivo JSON, pero está en formato de lista.
espana_json <- fromJSON(file = "INPUT/DATA/Enfermedades_laborales_España.json")

# Observamos la estructura, nos damos cuenta que posee listas anidadas
#str(espana_json)

# Convertimos la lista de la varable MetaData en un dataframe
MetaData_df<-
  espana_json%>%
  enter_object("MetaData")%>% # Extreamos la infromación dentro de "MetaData"
  gather_array() %>% # Convierte los elementos de un array en filas
  spread_all()%>% # Esta función distribuye cualquier objeto JSON que sea escalar en nuevas columnas
  select(T3_Variable, Nombre, Codigo) # Seleccionamos las tres variables que posee 

# Convertimos la lista de la variable Data en un dataframe
Data_df<-
  espana_json%>%
  enter_object("Data")%>% # Extreamos la infromación dentro de "Data"
  gather_array() %>% 
  spread_all()%>%
  select(Valor) # Seleccionamos la variable que posee 

# Unimos MetaData_df y Data_df usando "..JSON". Extraemos la columna "..JSON" como identificador 
# Expandimos la columna "..JSON" con prefijo para evitar conflictos de nombres
MetaData_df <- 
  MetaData_df %>%
  unnest_wider(..JSON, names_sep = "_json")

Data_df <- 
  Data_df %>%
  unnest_wider(..JSON, names_sep = "_json")

# Creamos un identificador único para cada fila
MetaData_df <- 
  MetaData_df %>%
  mutate(id = row_number())

Data_df <- 
  Data_df %>%
  mutate(id = row_number())

# Hacemos la unión de los df por la columna id que hemos creado con la variable lista "..JSON"
espana_df <- 
  MetaData_df %>%
  left_join(Data_df, by = "id") %>% # Unimos con Data_df usando 'id'
  mutate(Nombre = espana_json$Nombre) # Agregamos la columna "Nombre" del espana_json

#attributes(MetaData_df)  
#attributes(Data_df)
#print(MetaData_df)
#print(Data_df)
#print(espana_json)
#print(espana_df)


datatable(espana_df)
```

### **Carga de datos XLS**
Queremos extraer los datos sobre los accidentes laborales que suceden en Canarias. 
Como es un archivo con extensión .xls, utilizamos read_excel.
```{r, warning=FALSE}
# Cargamos los archivos con extensión .xls
library(readxl)
library(DT)

canarias_df <- read_excel("INPUT/DATA/Accidentes_laborales_Canarias.xls")
#class(canarias_df)

#print(canarias_df)
datatable(canarias_df)
```

### **Carga de datos CSV**
Queremos extraer los datos sobre la salud mental en los habitantes de Canarias. 
Como es un archivo con extensión .csv, utilizamos read_delim e indicamos que el delimitador es ;
Al imprimirlo como tabla con la función datatable nos da un error con el formato, es decir, indica que hay un problema con la codificación del archivo CSV. En este caso, el error nos indica que los archivos están codificados en UTF-8, pero revisando la tabla incluye caracteres como acentos. Por eso, utilizamos locale que es una forma de configurar la codificación de caracteres que define cómo se representan los caracteres de texto en bytes.
En conclusión con encoding = "ISO-8859-1" queremos que R interprete el archivo usando la codificación Latin-1, esta configuración asegura que los caracteres especiales se lean e interpreten de forma adecuada, evitando caracteres raros.
```{r, warning=FALSE}
# Cargamos los archivos con extensión .csv
library(readr)
library(DT)

Salud_df <- read_delim ("INPUT/DATA/Estados_de_salud_Canarias.csv.csv", delim = ";", locale = locale(encoding = "ISO-8859-1"))
#class(Salud_df)

datatable(Salud_df)
```

### **Carga de datos XLSX**
Queremos extraer los datos sobre la gravedad de las enfermedades laborales producidas en Aragón. 
Como es un archivo con extensión .xlsx, utilizamos read_excel.
```{r, warning=FALSE}
# Cargamos los archivos con extensión .xlsx
library(readxl)
library(DT)

Aragon_df <- read_excel ("INPUT/DATA/070901-02_Por grado y sexo. Aragon.xlsx")
#class(Aragon_df)

print(Aragon_df)
datatable(Aragon_df)
```

## **Observar valores nulos**
Observamos los valores nulos del conjunto de datos sobre los accidentes laborales que suceden en Canarias. Con select observamos las columnas que poseen valores nulos..
```{r, warning=FALSE}
library(dplyr)

canarias_df %>%
select(where(~ all(is.na(.))))
```

## **Cambiar nombre de las columnas**
Vamos a cambiar los nombres de las distintas columnas de los datos extraídos.
Cambiamos los nombres de las columnas del conjunto de datos sobre los accidentes laborales que suceden en Canarias.
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(canarias_df)
canarias <- rename(.data = canarias_df, Año = `TIME_PERIOD#es`, Año2 = `TIME_PERIOD_CODE`, Sexo = `SEXO#es`, SexoCod = `SEXO_CODE`, Gravedad = `ACCIDENTE_GRAVEDAD#es`, GravedadCod = `ACCIDENTE_GRAVEDAD_CODE`, TipoTrab = `TIPO_TRABAJO#es`, TipoTrabCod = `TIPO_TRABAJO_CODE`, TrabHabitual = `TRABAJO_HABITUAL#es`, TrabHabCod = `TRABAJO_HABITUAL_CODE`, Obs = `OBS_VALUE`, ConfeciObs = `CONFIDENCIALIDAD_OBSERVACION#es`, Notasobs = `NOTAS_OBSERVACION#es`, Estadosobs = `ESTADO_OBSERVACION#es`)

datatable(canarias)
```
Cambiamos los nombres de las columnas del conjunto de datos sobre la gravedad de las enfermedades laborales producidas en Aragón. 
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(Aragon_df)
Aragon <- rename(.data = Aragon_df, NumAcci = `Nº Accidentes`, Gravedad = `Grupo Grado Código...4`, GravedadCod = `Grupo Grado Código...5`)

#print(Aragon)
datatable(Aragon)
```

Cambiamos los nombres de las columnas del conjunto de datos sobre las enfermedades laborales que suceden en España. 
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(espana_df)
Espana <- rename(.data = espana_df, TipoEnf = `T3_Variable`, Indicador = `Codigo`, Variable = `..JSON_jsonT3_Variable`, Nombre = `..JSON_jsonNombre`, Codigo = `..JSON_jsonCodigo`, jsonValor = `..JSON_jsonValor`)

#print(Espana)
datatable(Espana)
```
Cambiamos los nombres de las columnas del conjunto de datos sobre la salud mental en los habitantes de Canarias.
```{r, warning=FALSE}
library(tidyverse)
library(DT)

#attributes(Salud_df)
Salud <- rename(.data = Salud_df, Sexo = `sexos_grupos_edad`, EstadoAnsiedad = `autovaloracion_estado_salud_relacion_situaciones_ansiedad`, Años = `anios`, Obs = `poblacion_16_mas_anios`)

#print(Salud)
datatable(Salud)
```

## **Eliminar columnas**
Eliminamos las columnas que no nos va a interesar estudiar para ello, seleccionamos las columnas que nos interesan. 
En el único conjunto de datos que no vamos a eliminar columnas es en los datos sobre la salud mental en los habitantes de Canarias.
Primero vamos a eliminar las columnas del conjunto de datos de canarias. Nos vamos a quedar solo con las columnas Año, Sexo, Gravedad, TipoTrab y Obs.
```{r, warning=FALSE} 
library(dplyr)

canarias <- 
  canarias%>% 
  select(Año, Sexo, Gravedad, TipoTrab, Obs)
datatable(canarias)
```
En segundo lugar, eiminamos las columnas del conjunto de datos de Aragon. Nos vamos a quedar solo con las columnas Año, Sexo, NumAcci y Gravedad.
```{r, warning=FALSE} 
library(dplyr)

Aragon <- 
  Aragon%>%
  select(Año, Sexo, NumAcci, Gravedad)
datatable(Aragon)
```
En tercer lugar, eiminamos las columnas del conjunto de datos de Espana. Nos vamos a quedar solo con las columnas Nombre, id y Valor.
```{r, warning=FALSE} 
library(dplyr)

Espana <- 
  Espana%>%
  select(Nombre, id, Valor)
datatable(Espana)
```

## **Eliminar filas**
Eliminamos las filas que no nos va a interesar estudiar.
```{r, warning=FALSE, error = TRUE}
#ELIMINAR FILAS

Salud <- subset(Salud, !Sexo %in% c("De 16 a 64 a\xf1os", "De 65 y m\xe1s a\xf1os"))

```

## **Realizar un dataframe conjunto**
Realizamos un dataframe uniendo los datos sobre la gravedad de las enfermedades laborales en Aragón y la salud mental de los ciudadanos en Canarias.
```{r, warning=FALSE}
library(DT)

# Unimos por una columna común "Sexo"
df_Salu_Arag <- merge(Aragon, Salud, by = "Sexo")

datatable(df_Salu_Arag)
```

Realizamos un dataframe uniendo los datos sobre los accidentes laborales que suceden en Canarias y los datos sobre las enfermedades laborales que suceden en España. Como tenemos dos nombres de columnas diferentes aunque recoge el mismo tipo de valores vamos a utilizar un inner_join buscando coincidencias exactas entre el atributo Obs del conjunto de datos Espana y el atributo Valor del conjunto de datos canarias.
Como existen valores iguales en ambos atributos eliminamos duplicados.

```{r,  warning=FALSE}
library(DT)

canarias_dis <-
  canarias %>%
  distinct(Obs, .keep_all = TRUE)

Espana_dis <-
  Espana %>%
  distinct(Valor, .keep_all = TRUE)

df_cana_Esp <- 
  canarias_dis %>%
  inner_join(Espana_dis, by = c("Obs" = "Valor"))

datatable(df_cana_Esp)
```

## **Función**
Cantidad de hombres y mujeres del dataframe

```{r, warning=FALSE}
hombres <- sum(df_cana_Esp$Sexo == "Hombres")
mujeres <- sum(df_cana_Esp$Sexo == "Mujeres")


print(hombres)
print (mujeres)
```

Sumatorio de casos en los que muestra la cantidad de personas (según el sexo) que tienen el tipo de enfermedad
```{r, warning=FALSE}

cat("¿Quieres saber cuantos hombres (1), mujeres (2) o total (3) tienen problemas óseos?")



condicion <- as.integer(readline(prompt = "Ingresa el número de la condición (1, 2 o 3): "))

numero <- 0

if (condicion == 1){
  for (i in 1:nrow(df_cana_Esp)) {
    if (df_cana_Esp$Sexo[i] == "Hombres" && df_cana_Esp$Nombre[i] == "Problema óseo, articular o muscular que afecta principalmente a las caderas, las piernas o los pies")
      {numero <- numero + 1
    } 
  }
} else if (condicion == 2){
  for (i in 1:nrow(df_cana_Esp)) {
  if (df_cana_Esp$Sexo[i] == "Mujeres" && df_cana_Esp$Nombre[i] == "Problema óseo, articular o muscular que afecta principalmente a las caderas, las piernas o los pies")
    {numero <- numero + 1
    } 
  }
} else if (condicion == 3) {
  for (i in 1:nrow(df_cana_Esp)) {
  if (df_cana_Esp$Sexo[i] == "Total" && df_cana_Esp$Nombre[i] == "Problema óseo, articular o muscular que afecta principalmente al cuello, los hombros, los brazos o l") {
      numero <- numero + 1
    }
  }
} else {
  cat("Ingresa una de estas opciones: 1, 2 o 3\n")
}

cat("\nEl número de casos es:", numero, "\n")


```

Imágenes que muestran los daños que ocurren en los distintos casos: 

<img src='images/I1.jpg' align="center" height="120" />

<img src='images/I2.jpg' align="center" height="120" />

<img src='images/I3.jpg' align="center" height="120" />

Función que determina la cantidad de personas que tienen una enfermedad segun el sexo y la enfermedad
```{r, warning=FALSE}
Cantidad1 <- df_cana_Esp$Obs[df_cana_Esp$Sexo == "Hombres" & df_cana_Esp$Nombre == "Problema óseo, articular o muscular que afecta principalmente a las caderas, las piernas o los pies"]

print(Cantidad1)

Cantidad2 <- df_cana_Esp$Obs[df_cana_Esp$Sexo == "Total" & df_cana_Esp$Nombre == "Problema óseo, articular o muscular que afecta principalmente al cuello, los hombros, los brazos o l"]
  
print (sum(Cantidad2))
```

## **Pivotar**
Vamos a transponer la estructura de nuestra tabla ordenada Espana desde largo a ancho.
```{r, warning=FALSE}
Long_Espana <- pivot_wider(data = Espana, names_from = "Nombre", values_from = "Valor")

datatable(Long_Espana)
```

## **Añdir columnas**
Utilizamos mutate para sacar el porcentaje que representa cada observación respecto al conjunto de observaciones del conjunto de datos de canarias.
Con options(scipen=999) evitamos la notación científica.
```{r, warning=FALSE}
library(dplyr)
library(DT)

options(scipen = 999)
datatable(mutate(.data = canarias, Porcentaje_Obs = (Obs / sum(Obs)) * 100))
```
HACERLO BIEN??
```{r, warning=FALSE}
library(dplyr)
library(DT)

options(scipen = 999)
print(Espana$Valor)
sum(Espana$Valor)
datatable(mutate(.data = Espana, Porcentaje_Valor = (Valor / sum(Valor)) * 100))
```


## **Gráfico**
Añadimos un gráfico de barras para observar el número de accidentes laborales sucedidos durante los difrentes años en Aragón. Para ello, utilizaremos el atributo de Año y NumAcci del conjunto de datos sobre los accidentes laborales en Aragón.
```{r, warning=FALSE}
library(tidyverse)
library(ggplot2)

ggplot(data = Aragon, aes(x = Año, y = NumAcci)) +
  geom_bar(stat = "identity", fill = "darkturquoise") +
  xlab("Año del suceso") +
  ylab("Número de accidentes laborales") +
  ggtitle(label = "Número de accidentes según el año del suceso")
```

## **Facetas**
```{r, warning=FALSE}
library(tidyverse)
library(ggplot2)

ggplot(data = Salud, aes(x = Obs, y = EstadoAnsiedad)) +
  geom_point(aes(colour = factor(Años), shape=factor(Sexo))) +
  xlab("Observaciones") +
  ylab("Tipos de estados de ansiedad") +
  ggtitle(label = "Observaciones del estado de ansiedad según el año")
```

# **Resultados**

# **Conclusiones**
añadir los dos url de los articulos
https://www.omniamachinery.com/es/2022/05/mental-health-in-construction/

# **Referencias**
*Enfermedades relacionadas con el trabajo.* (2024, 9 diciembre). Safety And Health At Work EU-OSHA. https://osha.europa.eu/es/themes/work-related-diseases

*Human verification.* (s. f.). Stack Overflow. https://stackoverflow.com/search?q=input+string+1+is+invalid+UTF-8

World Health Organization: WHO. (2022b, junio 8). *Trastornos mentales*. https://www.who.int/es/news-room/fact-sheets/detail/mental-disorders

Gómez, M. G., López, R. C., Ortiz, Z. H., & Soria, F. S. (s. f.). *Reconocimiento de enfermedades profesionales según sexo, ocupación y actividad de la empresa en España (1999-2009).* https://www.redalyc.org/journal/170/17049838011/html/#:~:text=Fundamentos%3A%20Seg%C3%BAn%20las%20estad%C3%ADsticas%20oficiales,participaci%C3%B3n%20en%20el%20mundo%20laboral.

*imagen daño oseo - Bing. (s. f.).* Bing. https://www.bing.com/images/search?view=detailV2&ccid=HIZKeiyE&id=8A29147F9411B08DEB7C49034609DD195464A548&thid=OIP.HIZKeiyEroiF0yAK1ajaLwHaD3&mediaurl=https%3a%2f%2fwww.comunidadmielomamultiple.com%2fwp-content%2fuploads%2fcemmp-dano-oseo.webp&cdnurl=https%3a%2f%2fth.bing.com%2fth%2fid%2fR.1c864a7a2c84ae8885d3200ad5a8da2f%3frik%3dSKVkVBndCUYDSQ%26pid%3dImgRaw%26r%3d0&exph=627&expw=1200&q=imagen+da%c3%b1o+oseo&FORM=IRPRST&ck=52479B4305056814AD24AB193C144909&selectedIndex=7&itb=0&ajaxhist=0&ajaxserp=0

*imagen daño muscular - Bing. (s. f.).* Bing. https://www.bing.com/images/search?view=detailV2&ccid=aV2FcEIh&id=D6AACCBEBEF450E1CBDF67C21D16BF507DF9DA43&thid=OIP.aV2FcEIhl45rkm4m6VFzRgHaD5&mediaurl=https%3a%2f%2frealidadfitness.com%2fwp-content%2fuploads%2f2019%2f05%2fentrenamiento-da%c3%b1o-muscular-1024x538.jpg&cdnurl=https%3a%2f%2fth.bing.com%2fth%2fid%2fR.695d85704221978e6b926e26e9517346%3frik%3dQ9r5fVC%252fFh3CZw%26pid%3dImgRaw%26r%3d0&exph=538&expw=1024&q=imagen+da%c3%b1o+muscular&FORM=IRPRST&ck=99E22962D1608D4D57756ACE0E6D4FE9&selectedIndex=1&itb=0&ajaxhist=0&ajaxserp=0

*imagen daño articular - Bing. (s. f.).* Bing. https://www.bing.com/images/search?view=detailV2&ccid=KaDQGmnp&id=2E3760EF62FCCC59509810F95B6010E199FCE071&thid=OIP.KaDQGmnpM8DYGR0vUebPSAHaEM&mediaurl=https%3a%2f%2fvitalclinic.es%2fwp-content%2fuploads%2f2019%2f11%2fartrosis-reumatoide.jpg&cdnurl=https%3a%2f%2fth.bing.com%2fth%2fid%2fR.29a0d01a69e933c0d8191d2f51e6cf48%3frik%3dceD8meEQYFv5EA%26pid%3dImgRaw%26r%3d0&exph=680&expw=1200&q=imagen+da%c3%b1o+articular&FORM=IRPRST&ck=62865A1BF4CB8E9BA729F41897ADACED&selectedIndex=2&itb=0&ajaxhist=0&ajaxserp=0